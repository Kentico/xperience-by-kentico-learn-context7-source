<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Access custom channel-specific configurations</title>
</head>
<body>
<p>When you build <a href="/documentation/developers-and-admins/customization/extend-the-administration-interface/ui-pages">custom module UIs</a> with Xperience by Kentico, chances are you’ll need to access and react to the <a href="/documentation/developers-and-admins/customization/object-types">data stored in the modules’ classes</a>.</p>
<p>Let’s go over the process of accessing and utilizing the values of module classes that are associated with specific web channels with practical examples. We will explore how to access custom channel-specific settings with Microsoft’s <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-8.0" target="_blank">options pattern</a>, then later without.</p>

<div>
<p><a href="/guides/development/customizations-and-integrations/add-channels-to-module">Earlier in this series</a>, we went over the process of creating custom channel-specific settings:</p>

<p>Now, we’ll dive into the process of accessing these settings in code.</p>
</div>

<h2 id="before-you-start">Before you start</h2>
<p>This guide requires the following:</p>
<ul>
<li>Familiarity with <a href="https://learn.microsoft.com/en-us/dotnet/csharp/" target="_blank">C#</a>, <a href="https://learn.microsoft.com/en-us/dotnet/" target="_blank">.NET Core</a>, <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection" target="_blank">Dependency injection</a>, and the <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/overview" target="_blank">MVC pattern</a>.</li>
<li>A running instance of Xperience by Kentico, preferably <a href="/documentation/changelog">30.6.2</a> or higher.

<div>

</div>
<div>
Some features covered in the Training guides may not work in older versions.
</div>
</li>
</ul>
<p>The examples in this guide require that you:</p>
<ul>
<li>Have followed along with the samples from <a href="/guides/development/customizations-and-integrations/add-channels-to-module">the previous guide</a> about creating the UI for channel-specific configurations.</li>
</ul>

<div>
<p><strong>Code samples</strong></p>
<p>You can find a project with completed, working versions of code samples from this guide and others in the <a href="https://github.com/Kentico/xperience-by-kentico-training-guides/tree/finished" target="_blank">finished branch</a> of the <em>Training guides</em> repository.</p>
<p>The <a href="https://github.com/Kentico/xperience-by-kentico-training-guides" target="_blank">main branch</a> of the repository provides a starting point to code along with the guides.</p>
<p>The code samples in this guide are for <a href="https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8/overview" target="_blank">.NET 8</a> only.</p>
<p>They come from a project that uses <a href="https://learn.microsoft.com/en-us/dotnet/core/project-sdk/overview#implicit-using-directives" target="_blank">implicit using directives</a>. You may need to add additional <code>using</code> directives to your code if your project does not use this feature.</p>
</div>

<h2 id="work-with-the-options-pattern-serve-robots.txt">Work with the Options pattern (Serve robots.txt)</h2>
<p>As with the global configurations described in the <a href="/guides/development/customizations-and-integrations/access-custom-global-configurations#expose-your-custom-configuration">earlier guide</a>, you can use channel-specific custom module configurations with the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-8.0" target="_blank">options pattern</a>.</p>
<p>To put this into practice, let’s create functionality to serve the <strong>robots.txt</strong> file specified in the <em>SEO settings</em> of the <a href="/guides/development/customizations-and-integrations/add-channels-to-module">we created earlier</a>.</p>
<h3 id="populate-the-data">Populate the data</h3>
<p>Start by adding data for the code to retrieve.</p>
<p>For this guide’s example, navigate to <strong>Project settings → Channel settings → Training guides pages → SEO settings</strong> in the admin UI.</p>
<p>Save a value to the <strong>Robots.txt</strong> text box, for example:</p>

<div>
<div>
<div>
<span>Text</span>
</div>
<strong></strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
ignore: *
</code></pre>
</div>

<h3 id="set-up-options">Set up options</h3>
<p>Moving to the code files, create an <em>options class</em> to hold all the data your front-end needs, and a corresponding <em>options setup class</em> to populate that data.</p>
<p>To retrieve the value of your setting, use an <code>IWebsiteChannelContext</code> instance to determine which channel’s module data to retrieve, and an <code>IInfoProvider&lt;TInfo&gt;</code> for each module class you need to access.</p>
<p>Then, register the setup class with the dependency injection container during startup, for example in an <code>IServiceCollection</code> extension method.</p>
<p>If you’re following along with the example, add a folder called <em>SEO</em> within the <em>Features</em> directory of the <em>TrainingGuides.Web</em> project.</p>
Create <em>options</em> and <em>options setup</em> classes for <em>robots.txt</em>.

<div>

</div>
<div>
Make sure to evaluate the current channel to retrieve the correct settings.
</div>


<div>
<div>
<div>
<span>C#</span>
</div>
<strong>RobotsOptions.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
namespace TrainingGuides.Web.Features.SEO;

public class RobotsOptions
{
    public string RobotsText { get; set; } = string.Empty;
}
</code></pre>
</div>

<p></p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>RobotsOptionsSetup.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>

using CMS.DataEngine;
using CMS.Websites.Routing;
using Microsoft.Extensions.Options;
using TrainingGuides.ProjectSettings;

namespace TrainingGuides.Web.Features.SEO;
public class RobotsOptionsSetup : IConfigureOptions&lt;RobotsOptions&gt;
{
    private readonly IInfoProvider&lt;SeoSettingsInfo&gt; seoSettingsInfoProvider;
    private readonly IWebsiteChannelContext websiteChannelContext;
    private readonly IInfoProvider&lt;WebChannelSettingsInfo&gt; webChannelSettingsInfoProvider;

    public RobotsOptionsSetup(IInfoProvider&lt;SeoSettingsInfo&gt; seoSettingsInfoProvider, IWebsiteChannelContext websiteChannelContext, IInfoProvider&lt;WebChannelSettingsInfo&gt; webChannelSettingsInfoProvider)
    {
        this.seoSettingsInfoProvider = seoSettingsInfoProvider;
        this.websiteChannelContext = websiteChannelContext;
        this.webChannelSettingsInfoProvider = webChannelSettingsInfoProvider;
    }

    public void Configure(RobotsOptions options)
    {
        int currentChannelID = websiteChannelContext.WebsiteChannelID;

        var channelSettings = webChannelSettingsInfoProvider
            .Get()
            .WhereEquals(nameof(WebChannelSettingsInfo.WebChannelSettingsChannelID), currentChannelID)
            .FirstOrDefault();

        var seoSettings = seoSettingsInfoProvider.Get()
            .WhereEquals(nameof(SeoSettingsInfo.SeoSettingsWebChannelSettingID), channelSettings?.WebChannelSettingsID ?? 0)
            .FirstOrDefault();

        options.RobotsText = seoSettings?.SeoSettingsRobots ?? string.Empty;
    }
}
</code></pre>
</div>

<p>Then, in the <code>ServiceCollectionExtensions.AddTrainingGuidesOptions</code> method from the earlier guide, use the <code>IServiceCollection.ConfigureOptions</code> method to register your options.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>ServiceCollectionExtensions.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
...
public static void AddTrainingGuidesOptions(this IServiceCollection services)
{
    ...
    services.ConfigureOptions&lt;RobotsOptionsSetup&gt;();
}
...
</code></pre>
</div>


<div>

</div>
<div>
<p>You can find the complete file <a href="https://github.com/Kentico/xperience-by-kentico-training-guides/blob/finished/src/TrainingGuides.Web/ServiceCollectionExtensions.cs" target="_blank">in the finished branch of the <em>Training guides repository</em></a> for reference.</p>
</div>

<h3 id="utilize-the-options-in-your-project">Utilize the options in your project</h3>
<p>Once you have set up and registered, you can utilize them anywhere in your site that allows dependency injection.</p>

<div>

</div>
<div>
<p><strong>Choose which <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-8.0#options-interfaces" target="_blank"><strong>Options interface</strong></a> to use</strong></p>
<p>In cases where the values of the options do not change during the life of the application, you can use <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.options.ioptions-1?view=net-8.0" target="_blank"><code>IOptions&lt;TOptions&gt;</code></a> to retrieve the value. It is a <strong>singleton</strong> service that evaluates the options when the application stops.</p>
<p>In this case, you’ll most likely want to use <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.options.ioptionssnapshot-1?view=net-8.0" target="_blank"><code>IOptionsSnapshot&lt;TOptions&gt;</code></a> instead, as it is a <strong>scoped service</strong> that re-evaluates the options <em>whenever it is constructed</em>. This ensures that if users make changes to your module objects after the application starts, the new values will be included in the options.</p>
</div>

<p>For our example, let’s create a controller that returns a text response with the value of the <em>robots.txt</em> setting from the injected options.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>RobotsController.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>

using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Options;

namespace TrainingGuides.Web.Features.SEO;
public class RobotsController : Controller
{
    private readonly IOptionsSnapshot&lt;RobotsOptions&gt; robotsOptions;

    public RobotsController(IOptionsSnapshot&lt;RobotsOptions&gt; robotsOptions)
    {
        this.robotsOptions = robotsOptions;
    }

    [HttpGet("/robots.txt")]
    public IActionResult Index() =&gt; Content(robotsOptions.Value.RobotsText, "text/plain");
}
</code></pre>
</div>

<h3 id="see-the-result">See the result</h3>
<p>If you’ve followed along with the example, try visiting the <strong>/robots.txt</strong> path of the live site.</p>
<p>You should see a response containing the value you saved in the SEO settings.</p>
<p></p>
<p>Feel free to change the value of the setting, and see that it is reflected in this response.</p>
<h2 id="access-data-directly-render-snippets-to-the-site">Access data directly (Render snippets to the site)</h2>
<p>We recommend using the options pattern to follow .NET best practices, but if it does not fit your team’s code style, it is not necessary.</p>
<p>Earlier in this series, we created a module that allows users to define code snippets associated with a given channel. For this guide’s sample, let’s create a view component that retrieves the code snippets for the current channel and renders them to the layout page.</p>
<h3 id="enter-the-data">Enter the data</h3>
<p>Once again we need to add some data, so that our code has something to work with.</p>
<p>In the admin UI, navigate to <strong>Project settings → Channel settings → Training guides pages → Channel snippets</strong> in the Xperience admin UI.</p>
<p>Add one of each type of snippet. If you don’t have specific tags you want to include, you can use:</p>
<ol type="1">
<li>First snippet
<ul>
<li>
<strong>Label</strong>: Test meta</li>
<li>
<strong>Identifiers → Code name</strong>: TestMeta</li>
<li>
<strong>Type</strong>: Metadata</li>
<li>
<strong>Code</strong>:

<div>
<div>
<div>
<span>HTML</span>
</div>
<strong></strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
  &lt;meta name="this is a test" content="12345"&gt;
  </code></pre>
</div>
</li>
</ul>
</li>
<li>Second snippet
<ul>
<li>
<strong>Label</strong>: Test CSS</li>
<li>
<strong>Identifiers → Code name</strong>: TestCSS</li>
<li>
<strong>Type</strong>: CSS</li>
<li>
<strong>Code</strong>:

<div>
<div>
<div>
<span>HTML</span>
</div>
<strong></strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
  &lt;style&gt;
      .newclass{
          display:inline;
      }
  &lt;/style&gt;
  </code></pre>
</div>
</li>
</ul>
</li>
<li>Third snippet
<ul>
<li>
<strong>Label</strong>: Test javascript</li>
<li>
<strong>Identifiers → Code name</strong>: TestJavascript</li>
<li>
<strong>Type</strong>: Javascript</li>
<li>
<strong>Code</strong>:<br>


<div>
<div>
<div>
<span>HTML</span>
</div>
<strong></strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
  &lt;script&gt;
      var toInsert = document.createElement("div");
      toInsert.innerHTML = "This text was added through a javascript snippet in the &lt;b&gt;Project settings&lt;/b&gt; application.";
      document.body.appendChild(toInsert);
  &lt;/script&gt;
  </code></pre>
</div>
</li>
</ul>
</li>
</ol>

<div>

</div>
<div>
<p>The CSS and JavaScript snippets do not need to be inline code, as in this example. They can link to other resources.</p>
</div>

<h3 id="add-supporting-files">Add supporting files</h3>
<p>Our example view component needs some additional foundational code:</p>
<p>First, create a <em>CodeSnippets</em> folder beneath the <em>Features</em> folder of the <em>TrainingGuides.Web</em> project.</p>
<p>Then add a <code>CodeSnippetType</code> enumeration that corresponds to the <strong>WebChannelSnippetType</strong> property that we defined in the class.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>CodeSnippetType.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
public enum CodeSnippetType
{
    Metadata,
    CSS,
    Javascript,
}
</code></pre>
</div>

<p>Finally, define a view model with properties for the code, type, and label of a code snippet.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>CodeSnippetViewModel.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
using Microsoft.AspNetCore.Html;

namespace TrainingGuides.Web.Features.CodeSnippets;

public class CodeSnippetViewModel
{
    public HtmlString CodeSnippetHtml { get; set; } = new HtmlString(string.Empty);
    public string CodeSnippetType { get; set; } = string.Empty;
    public string CodeSnippetLabel { get; set; } = string.Empty;
}
</code></pre>
</div>

<h3 id="retrieve-the-values">Retrieve the values</h3>
<p>In general, retrieving channel-specific module class values without the options pattern is the same approach you used in the <a href="#OptionsSetupFile">options setup file</a>. You can use an <code>IWebsiteChannelContext</code> object to get the current channel, and an <code>IInfoProvider&lt;TInfo&gt;</code> object or <a href="/documentation/developers-and-admins/api/generate-code-files-for-system-objects#generate-code-files">dedicated provider</a> to access objects of your module class.</p>
<p>For our example, add an asynchronous view component to the <em>CodeSnippets</em> folder. Add parameters to <code>InvokeAsync</code> that specify which type of snippet should be retrieved, and whether the snippet should be labelled with an HTML comment.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>CodeSnippetsViewComponent.cs</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
using CMS.DataEngine;
using CMS.Websites.Routing;
using Microsoft.AspNetCore.Html;
using Microsoft.AspNetCore.Mvc;
using TrainingGuides.ProjectSettings;

namespace TrainingGuides.Web.Features.CodeSnippets;

public class CodeSnippetsViewComponent : ViewComponent
{
    private readonly IInfoProvider&lt;WebChannelSnippetInfo&gt; webChannelSnippetInfoProvider;
    private readonly IInfoProvider&lt;WebChannelSettingsInfo&gt; webChannelSettingsInfoProvider;
    private readonly IWebsiteChannelContext websiteChannelContext;

    public CodeSnippetsViewComponent(IInfoProvider&lt;WebChannelSnippetInfo&gt; webChannelSnippetInfoProvider, IInfoProvider&lt;WebChannelSettingsInfo&gt; webChannelSettingsInfoProvider, IWebsiteChannelContext websiteChannelContext)
    {
        this.webChannelSnippetInfoProvider = webChannelSnippetInfoProvider;
        this.webChannelSettingsInfoProvider = webChannelSettingsInfoProvider;
        this.websiteChannelContext = websiteChannelContext;
    }

    public async Task&lt;IViewComponentResult&gt; InvokeAsync(CodeSnippetType codeSnippetType, bool addLabelComments = false)
    {
        // Retrieve the current channel
        int currentChannelID = websiteChannelContext.WebsiteChannelID;

        // Use the channel to get the associated web channel settings
        var settings = webChannelSettingsInfoProvider
            .Get()
            .WhereEquals(nameof(WebChannelSettingsInfo.WebChannelSettingsChannelID), currentChannelID)
            .AsSingleColumn(nameof(WebChannelSettingsInfo.WebChannelSettingsID));

        // Aquire snippets associated with the web channel settings
        var snippets = await webChannelSnippetInfoProvider
            .Get()
            .WhereIn(nameof(WebChannelSnippetInfo.WebChannelSnippetWebChannelSettingsID), settings)
            .WhereEquals(nameof(WebChannelSnippetInfo.WebChannelSnippetType), codeSnippetType.ToString())
            .GetEnumerableTypedResultAsync();

        // Return an IEnumerable collection of CodeSnippetViewModel objects
        var model = snippets.Select(snippet =&gt; new CodeSnippetViewModel
        {
            CodeSnippetHtml = new HtmlString(snippet.WebChannelSnippetCode),
            CodeSnippetType = snippet.WebChannelSnippetType,
            // If the view component is configured to add comment labels, use the display name
            CodeSnippetLabel = addLabelComments
            ? snippet.WebChannelSnippetDisplayName
            : string.Empty
        });
        return View("~/Features/CodeSnippets/CodeSnippetsViewComponent.cshtml", model);
    }
}

</code></pre>
</div>

<h3 id="utilize-the-data">Utilize the data</h3>
<p>Now that you have your custom module data, you can put it into practice. For example, use it in your business logic, or to control how your application renders parts of the display.</p>
<p>In the case of our example, it means creating the view for our view component, and using it to render code snippets to the page.</p>
Add a new view, matching the path and name specified in the view component. For each code snippet in the provided model, render it to the page.

<div>

</div>
<div>
Make sure to include a comment label if the model provides one.
</div>


<div>
<div>
<div>
<span>cshtml</span>
</div>
<strong>CodeSnippetsViewComponent.cshtml</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
@using TrainingGuides.Web.Features.CodeSnippets
@model IEnumerable&lt;CodeSnippetViewModel&gt;

@foreach (var codeSnippet in Model)
{
    if (!string.IsNullOrWhiteSpace(codeSnippet.CodeSnippetLabel))
    {
        &lt;!-- code snippet for @codeSnippet.CodeSnippetLabel --&gt;
    }
    @codeSnippet.CodeSnippetHtml
}
</code></pre>
</div>

<p>Finally, utilize this view component in the <em>_Layout.cshtml</em> view, found in the <em>~/Views/Shared</em> folder of the <em>TrainingGuides.Web</em> project.</p>
<p>Place three instances of the view component into the view:</p>
<ul>
<li>one after the <code>meta</code> tags, with <code>code-snippet-type</code> set to <code>@CodeSnippetType.Metadata</code>
</li>
<li>one after the stylesheet links in the header, with <code>code-snippet-type</code> set to <code>@CodeSnippetType.CSS</code>
</li>
<li>one after the <code>script</code> tags at the bottom of the body, with <code>code-snippet-type</code> set to <code>@CodeSnippetType.Javascript</code>
</li>
</ul>

<div>

</div>
<div>
<p>Try setting <code>add-label-comments</code> to <code>true</code> on one of them, so you can compare the results.</p>
</div>


<div>
<div>
<div>
<span>cshtml</span>
</div>
<strong>_Layout.cshtml</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
...
&lt;html&gt;
    &lt;head&gt;
        ...
        &lt;vc:code-snippets code-snippet-type="@CodeSnippetType.Metadata" add-label-comments="true"/&gt;
        ...
        &lt;vc:code-snippets code-snippet-type="@CodeSnippetType.CSS" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
        ...
        &lt;vc:code-snippets code-snippet-type="@CodeSnippetType.Javascript" /&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
</div>


<div>

</div>
<div>
<p>For reference, you can find the completed layout file <a href="https://github.com/Kentico/xperience-by-kentico-training-guides/blob/finished/src/TrainingGuides.Web/Views/Shared/_Layout.cshtml" target="_blank">in the <em>finished</em> branch of the <em>Training guides</em> repo</a>.</p>
</div>

<h3 id="check-the-result">Check the result</h3>
<p>If you’ve followed the example, you should be able to find the tags in the source view of the page, and see the message rendered by the javascript at the very bottom.</p>
<p></p>
<p></p>
<h2 id="whats-next">What’s next?</h2>
<p>Throughout the <a href="/guides/development/customizations-and-integrations#custom-modules">Custom module series</a>, you’ve seen how to create custom module, including data associated with specific channels, and how to put the module data into practice.</p>
<p>Use this experience to expand upon the samples, or to build your your own complex module.</p>
<p>Check out <a href="/guides/development/customizations-and-integrations/add-custom-contact-field">this guide</a> to see how to add custom pages to existing system applications.</p>

</body>
</html>
